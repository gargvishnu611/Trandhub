<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trend Hub — Crypto Dashboard</title>
  <meta name="description" content="Trend Hub — live crypto prices, shared airdrops & news" />
  <!-- Firebase (compat for simple usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>

  <style>
  :root{
    --bg:#06131b; --card:#0f1b24; --muted:#9aa6b2; --accent:#ff9800; --accent2:#00e676;
    font-family: Inter, system-ui, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#04121a 0%, #071926 60%); color:#e6eef6; min-height:100vh;}
  header{display:flex;align-items:center;gap:16px;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ff6d00);display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .logo span{font-weight:800;color:#081018}
  h1{font-size:18px;margin:0}
  header .right{margin-left:auto;display:flex;gap:12px;align-items:center}
  .clock{font-size:14px;color:var(--muted)}
  .btn{background:var(--accent);color:#071018;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  main{padding:18px;display:grid;grid-template-columns:340px 1fr;gap:18px}
  .panel{background:linear-gradient(180deg,var(--card),#06131c);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,12,0.6)}
  .small{font-size:13px;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
  .list .item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.01)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;min-height:84px}
  .coin-head{display:flex;align-items:center;gap:10px}
  .price{font-size:18px;font-weight:800}
  .change.up{color:var(--accent2)}
  .change.down{color:#ff6b6b}
  footer{padding:18px;color:var(--muted);text-align:center}
  @media(max-width:980px){ main{grid-template-columns:1fr;padding:12px} }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" title="Trend Hub"><span>TH</span></div>
      <div>
        <h1>Trend Hub — Crypto</h1>
        <div class="small">Live prices • Shared airdrops & news • Admin-only editing</div>
      </div>
    </div>

    <div class="right">
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">Update</label>
        <select id="intervalSelect" class="small">
          <option value="1000">1s</option>
          <option value="2000">2s</option>
          <option value="3000">3s</option>
          <option value="5000" selected>5s</option>
          <option value="10000">10s</option>
        </select>
        <button class="btn secondary" id="toggleAuto">Pause</button>
      </div>
      <div style="width:12px"></div>
      <div class="clock" id="clock">--:--:--</div>
      <div style="width:12px"></div>
      <button class="btn" id="loginBtn">Sign in</button>
    </div>
  </header>

  <main>
    <!-- LEFT: Shared lists -->
    <div>
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="small">Shared Airdrops</div></div>
          <div>
            <button class="btn secondary" id="openAdminBtn" style="display:none">Admin Panel</button>
          </div>
        </div>
        <div id="airdropsList" class="list" style="margin-top:10px"></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Shared News</div>
          <div></div>
        </div>
        <div id="newsList" class="list" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- RIGHT: Coins -->
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="searchInput" placeholder="Search coin" style="padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:var(--muted)" />
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="small">Top</div>
          <select id="limitSelect" class="small">
            <option value="20">20</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <div class="grid" id="coinsGrid"></div>

      <div style="margin-top:12px" class="panel">
        <div class="small">Model Prediction (TF.js)</div>
        <div id="modelInfo" style="margin-top:8px;color:var(--muted)">Model trains automatically in your browser using recent price history.</div>
      </div>
    </div>
  </main>

  <footer>Trend Hub — Shared airdrops & news • Not financial advice</footer>

  <!-- modal -->
  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:50">
    <div style="background:#08121a;padding:16px;border-radius:10px;width:95%;max-width:720px;color:#e6eef6">
      <div id="modalContent"></div>
      <div style="text-align:right;margin-top:12px"><button class="btn secondary" id="closeModal">Close</button></div>
    </div>
  </div>

<script>
/* =========================
   Firebase config (your provided config)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAbk0t-AHFk3M7D8fHxwCwSvHKamPMac-o",
  authDomain: "trendhub-44381.firebaseapp.com",
  projectId: "trendhub-44381",
  storageBucket: "trendhub-44381.firebasestorage.app",
  messagingSenderId: "1048200840802",
  appId: "1:1048200840802:web:0bcc3d9a86d51b4444733b",
  measurementId: "G-75M36D4TQ9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* Admin emails */
const ADMINS = ["gargvishnu611@gmail.com","shivgarg184@gmail.com"];

/* UI helpers */
const $ = id=>document.getElementById(id);
function fmt(n){ return Number(n).toLocaleString(undefined, {maximumFractionDigits: 8}) }

/* Clock */
function updateClock(){ $('clock').innerText = new Date().toLocaleString(); }
setInterval(updateClock,1000); updateClock();

/* Auth UI */
const loginBtn = $('loginBtn');
const openAdminBtn = $('openAdminBtn');

auth.onAuthStateChanged(user=>{
  if(user){
    loginBtn.innerText = 'Sign out ('+ (user.email||'') +')';
    // show Admin panel button only for admins
    if(ADMINS.includes(user.email)){
      openAdminBtn.style.display = 'inline-block';
    } else {
      openAdminBtn.style.display = 'none';
    }
  } else {
    loginBtn.innerText = 'Sign in';
    openAdminBtn.style.display = 'none';
  }
});

loginBtn.addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if(user){
    await auth.signOut();
    alert('Signed out');
    return;
  }
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    const res = await auth.signInWithPopup(provider);
    if(!ADMINS.includes(res.user.email)) {
      // non-admins can view only - no problem
      alert('Signed in as: ' + res.user.email);
    } else {
      alert('Admin signed in: ' + res.user.email);
    }
  }catch(e){ console.error(e); alert('Sign-in failed: '+e.message) }
});

/* Admin Panel link */
openAdminBtn.addEventListener('click', ()=>{
  // open admin.html in same domain
  window.open('admin.html','_blank');
});

/* Firestore realtime */
const airdropsCol = db.collection('airdrops');
const newsCol = db.collection('news');

function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function escapeAttr(s){ return (s||'#').replace(/"/g,''); }

/* render airdrop item (view only) */
function renderAirdropView(doc){
  const data = doc.data();
  const div = document.createElement('div'); div.className='item';
  div.innerHTML = `<div style="flex:1">
    <strong>${escapeHtml(data.title||'Untitled')}</strong>
    <div class="small" style="color:var(--muted)">${data.date||'TBA'} • ${data.author||'anon'}</div>
  </div>
  <div style="display:flex;gap:8px">
    <a class="btn" target="_blank" href="${escapeAttr(data.link||'#')}">Open</a>
  </div>`;
  return div;
}

/* render news item */
function renderNewsView(doc){
  const data = doc.data();
  const div = document.createElement('div'); div.className='item';
  div.innerHTML = `<div style="flex:1">
    <strong>${escapeHtml(data.title||'Untitled')}</strong>
    <div class="small" style="color:var(--muted)">${data.time||''} • ${data.author||'anon'}</div>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn" onclick="viewNews('${doc.id}')">View</button>
  </div>`;
  return div;
}

/* realtime listeners */
airdropsCol.orderBy('createdAt','desc').onSnapshot(snap=>{
  $('airdropsList').innerHTML = '';
  snap.forEach(doc => $('airdropsList').appendChild(renderAirdropView(doc)));
});
newsCol.orderBy('createdAt','desc').onSnapshot(snap=>{
  $('newsList').innerHTML = '';
  snap.forEach(doc => $('newsList').appendChild(renderNewsView(doc)));
});

/* view news modal */
function viewNews(id){
  newsCol.doc(id).get().then(d=>{
    const data = d.data();
    openModal(`<h2>${escapeHtml(data.title)}</h2><div class="small" style="color:var(--muted)">${data.time||''}</div><p><a target="_blank" href="${escapeAttr(data.link||'#')}">Open link</a></p>`);
  })
}

/* Coins + TF.js prediction (client side) */
const COINGECKO_BASE = 'https://api.coingecko.com/api/v3';
let running = true;
let priceHistory = {}; // id -> [prices]
const HISTORY_LEN = 80;
const MODEL_WINDOW = 8;
const modelStore = {};

function recordPrice(id,p){
  if(!priceHistory[id]) priceHistory[id]=[];
  priceHistory[id].push(p);
  if(priceHistory[id].length>HISTORY_LEN) priceHistory[id].shift();
}
function fmt(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:8}) }

async function fetchTopCoins(limit=50){
  try{
    const res = await fetch(`${COINGECKO_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${limit}&page=1&sparkline=false`);
    return await res.json();
  }catch(e){ console.error(e); return [] }
}
function computePredictionText(id){
  const arr = priceHistory[id]||[];
  if(arr.length < MODEL_WINDOW+4) return 'training';
  const m = modelStore[id];
  if(!m) return 'training';
  try{
    const inputArr = arr.slice(-MODEL_WINDOW);
    const norm = inputArr.map(v=> v / inputArr[inputArr.length-1]);
    const input = tf.tensor2d([norm],[1,MODEL_WINDOW]);
    const out = m.predict(input);
    const pred = out.dataSync()[0];
    input.dispose(); out.dispose();
    if(pred > 1.002) return 'Up';
    if(pred < 0.998) return 'Down';
    return 'Flat';
  }catch(e){ console.error(e); return '—' }
}
async function buildAndTrainModelFor(id){
  const arr = priceHistory[id]||[];
  if(arr.length < MODEL_WINDOW+10) return;
  const X=[], Y=[];
  for(let i=0;i+MODEL_WINDOW < arr.length;i++){
    const x = arr.slice(i, i+MODEL_WINDOW);
    X.push(x.map(v => v / x[x.length-1]));
    Y.push(arr[i+MODEL_WINDOW] / x[x.length-1]);
  }
  if(X.length < 8) return;
  const xs = tf.tensor2d(X);
  const ys = tf.tensor2d(Y, [Y.length,1]);
  const model = tf.sequential();
  model.add(tf.layers.dense({units: 32, activation:'relu', inputShape:[MODEL_WINDOW]}));
  model.add(tf.layers.dense({units:16, activation:'relu'}));
  model.add(tf.layers.dense({units:1, activation:'linear'}));
  model.compile({optimizer: tf.train.adam(0.01), loss:'meanSquaredError'});
  try{
    await model.fit(xs, ys, {epochs: 25, batchSize: 16, verbose: 0});
    modelStore[id] = model;
    $('modelInfo').innerText = `Model trained for ${id} (samples:${X.length})`;
  }catch(e){ console.error(e); }
  xs.dispose(); ys.dispose();
}

function createCoinCard(c){
  const div = document.createElement('div'); div.className='card'; div.id = 'coin-'+c.id;
  const price = c.current_price;
  const change = c.price_change_percentage_24h;
  const predText = computePredictionText(c.id);
  div.innerHTML = `
    <div class="coin-head">
      <img src="${c.image}" style="width:36px;height:36px;border-radius:8px"/>
      <div style="flex:1">
        <div style="font-weight:700">${c.name} <span class="small" style="color:var(--muted)">(${c.symbol.toUpperCase()})</span></div>
        <div class="small" style="color:var(--muted)">MC: ${Number(c.market_cap).toLocaleString()}</div>
      </div>
      <div style="text-align:right">
        <div class="price">$${fmt(price)}</div>
        <div class="small ${change>=0?'change up':'change down'}">${change?change.toFixed(2)+'%':''}</div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div><div class="small">Prediction: <strong id="pred-${c.id}" style="color:#ccc">${predText}</strong></div></div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="openDetails('${c.id}')">Details</button>
        <button class="btn secondary" onclick="window.open('https://www.coingecko.com/en/coins/${c.id}','_blank')">Open</button>
      </div>
    </div>
  `;
  return div;
}

async function renderCoins(){
  const limit = parseInt($('limitSelect').value || 50);
  const list = await fetchTopCoins(limit);
  coinsGrid = $('coinsGrid');
  coinsGrid.innerHTML = '';
  list.forEach(c=>{
    recordPrice(c.id, c.current_price);
    const card = createCoinCard(c);
    coinsGrid.appendChild(card);
    setTimeout(()=>buildAndTrainModelFor(c.id), 500);
  });
}

async function updatePricesOnly(){
  const limit = parseInt($('limitSelect').value || 50);
  const list = await fetchTopCoins(limit);
  list.forEach(c=>{
    recordPrice(c.id, c.current_price);
    const el = $('coin-'+c.id);
    if(el){
      el.querySelector('.price').innerText = '$'+fmt(c.current_price);
      const ch = el.querySelector('.small.change');
      if(ch) ch.innerText = (c.price_change_percentage_24h||0).toFixed(2)+'%';
      const pred = computePredictionText(c.id);
      const predEl = $('pred-'+c.id);
      if(predEl) predEl.innerText = pred;
      if(Math.random() < 0.12) buildAndTrainModelFor(c.id);
    } else {
      const card = createCoinCard(c);
      $('coinsGrid').appendChild(card);
    }
  });
}

/* auto updater */
let updater = null;
function startUpdater(){
  if(updater) clearInterval(updater);
  const interval = parseInt($('intervalSelect').value || 5000);
  updater = setInterval(()=>{ if(running) updatePricesOnly(); }, interval);
  updatePricesOnly();
}

/* search */
$('searchInput').addEventListener('input', async e=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q){ renderCoins(); return; }
  try{
    const s = await fetch(`${COINGECKO_BASE}/search?query=${encodeURIComponent(q)}`).then(r=>r.json());
    const ids = s.coins.slice(0,30).map(x=>x.id).join(',');
    if(!ids) { $('coinsGrid').innerHTML = '<div class="small" style="color:var(--muted)">No coins</div>'; return; }
    const data = await fetch(`${COINGECKO_BASE}/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&per_page=50&page=1&sparkline=false`).then(r=>r.json());
    $('coinsGrid').innerHTML = '';
    data.forEach(c=>{ recordPrice(c.id, c.current_price); $('coinsGrid').appendChild(createCoinCard(c)); setTimeout(()=>buildAndTrainModelFor(c.id), 200); });
  }catch(e){ console.error(e); }
});

$('refreshBtn').addEventListener('click', ()=>renderCoins());
$('limitSelect').addEventListener('change', ()=>renderCoins());
$('intervalSelect').addEventListener('change', ()=>{ startUpdater(); });
$('toggleAuto').addEventListener('click', ()=>{ running = !running; $('toggleAuto').innerText = running ? 'Pause' : 'Resume'; });

/* modal */
function openModal(html){ $('modalContent').innerHTML = html; $('modal').style.display = 'flex'; }
$('closeModal').addEventListener('click', ()=>$('modal').style.display='none');

window.openDetails = function(id){
  const el = $('coin-'+id); if(!el) return;
  openModal(`<div style="max-height:60vh;overflow:auto">${el.innerHTML}</div>`);
};

/* init page */
(function init(){
  renderCoins();
  startUpdater();
})();
</script>
</body>
</html>
